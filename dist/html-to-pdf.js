"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.htmlToPdf = void 0;
const types_1 = require("./types");
const mustache_1 = __importDefault(require("mustache"));
const puppeteer_1 = __importDefault(require("puppeteer"));
const utils_1 = require("./utils");
const getHTML = async (options) => {
    let html = await (0, utils_1.getPageHTML)(options.template.type || types_1.HTMLType.CONTENT, options.template.content);
    if (options.data) {
        if (options.translations) {
            try {
                const translations = await (0, utils_1.getPageTranslations)(options.translations.resourceType, options.translations.translations);
                options.data = Object.assign(options.data, translations);
            }
            catch (error) {
                throw new Error('Invalid format for translations. Must be JSON');
            }
        }
        return mustache_1.default.render(html, options.data);
    }
    return html;
};
const htmlToPdf = async (options) => {
    var _a, _b, _c, _d;
    if (!options.pdf) {
        options.pdf = {};
    }
    if (!options.template && !options.url) {
        throw new Error('At least one of template or url must be specified');
    }
    const browser = await puppeteer_1.default.launch({ headless: true });
    const page = await browser.newPage();
    if ((_a = options.page) === null || _a === void 0 ? void 0 : _a.height) {
        await page.setViewport({
            width: options.page.width || 1600,
            height: options.page.height || 745.60,
        });
    }
    if (options.template) {
        const html = await getHTML(options);
        await page.setContent(html, { waitUntil: 'networkidle0' });
        if ((_b = options.template.css) === null || _b === void 0 ? void 0 : _b.content) {
            const pageStyles = (0, utils_1.getPageStylesAndScript)(options.template.css.type, options.template.css.content);
            await page.addStyleTag(pageStyles);
        }
        if ((_c = options.template.script) === null || _c === void 0 ? void 0 : _c.content) {
            const pageScript = (0, utils_1.getPageStylesAndScript)(options.template.script.type, options.template.script.content);
            await page.addScriptTag(pageScript);
        }
    }
    else {
        await page.goto((_d = options.url) === null || _d === void 0 ? void 0 : _d.link, { waitUntil: 'networkidle0' });
        if (options.url.auth) {
            await page.authenticate({
                username: options.url.auth.username,
                password: options.url.auth.password,
            });
        }
    }
    const pdfOptions = {
        format: options.pdf.format || 'A4',
        scale: options.pdf.scale || 1,
        landscape: options.pdf.landscape || false,
        margin: options.pdf.margin ? options.pdf.margin : undefined,
        displayHeaderFooter: !!options.template.header || !!options.template.footer,
        headerTemplate: options.template.header,
        footerTemplate: options.template.footer,
    };
    if (options.pdf.writeStream) {
        const pdfStream = await page.createPDFStream(pdfOptions);
        pdfStream.pipe(options.pdf.writeStream);
        pdfStream.on('end', async () => {
            await browser.close();
        });
    }
    else {
        const pdf = await page.pdf(pdfOptions);
        await browser.close();
        return pdf;
    }
};
exports.htmlToPdf = htmlToPdf;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHRtbC10by1wZGYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaHRtbC10by1wZGYudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsbUNBQXVEO0FBQ3ZELHdEQUFnQztBQUNoQywwREFBa0Q7QUFDbEQsbUNBQW1GO0FBRW5GLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxPQUEyQixFQUFFLEVBQUU7SUFDbEQsSUFBSSxJQUFJLEdBQUcsTUFBTSxJQUFBLG1CQUFXLEVBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLElBQUksZ0JBQVEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNsRyxJQUFJLE9BQU8sQ0FBQyxJQUFJLEVBQUU7UUFDZCxJQUFJLE9BQU8sQ0FBQyxZQUFZLEVBQUU7WUFDdEIsSUFBSTtnQkFDQSxNQUFNLFlBQVksR0FBRyxNQUFNLElBQUEsMkJBQW1CLEVBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsT0FBTyxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDckgsT0FBTyxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7YUFDNUQ7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDWixNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7YUFDcEU7U0FDSjtRQUNELE9BQU8sa0JBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUM5QztJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUMsQ0FBQztBQUVLLE1BQU0sU0FBUyxHQUFHLEtBQUssRUFBRSxPQUEyQixFQUFFLEVBQUU7O0lBQzNELElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFO1FBQ2QsT0FBTyxDQUFDLEdBQUcsR0FB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UUFDdkMsY0FBYyxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTTtLQUM1QixDQUFDO0lBRWhCLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUU7UUFDekIsTUFBTSxTQUFTLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3pELFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN4QyxTQUFTLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxLQUFLLElBQUksRUFBRTtZQUMzQixNQUFNLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUMxQixDQUFDLENBQUMsQ0FBQztLQUNOO1NBQU07UUFDSCxNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdkMsTUFBTSxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDdEIsT0FBTyxHQUFHLENBQUM7S0FDZDtBQUNMLENBQUMsQ0FBQztBQXhEVyxRQUFBLFNBQVMsYUF3RHBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSFRNTFR5cGUsIFBERkZyb21IVE1MT3B0aW9ucyB9IGZyb20gXCIuL3R5cGVzXCI7XG5pbXBvcnQgTXVzdGFjaGUgZnJvbSAnbXVzdGFjaGUnO1xuaW1wb3J0IHB1cHBldGVlciwgeyBQREZPcHRpb25zIH0gZnJvbSAncHVwcGV0ZWVyJztcbmltcG9ydCB7IGdldFBhZ2VIVE1MLCBnZXRQYWdlU3R5bGVzQW5kU2NyaXB0LCBnZXRQYWdlVHJhbnNsYXRpb25zIH0gZnJvbSBcIi4vdXRpbHNcIjtcblxuY29uc3QgZ2V0SFRNTCA9IGFzeW5jIChvcHRpb25zOiBQREZGcm9tSFRNTE9wdGlvbnMpID0+IHtcbiAgICBsZXQgaHRtbCA9IGF3YWl0IGdldFBhZ2VIVE1MKG9wdGlvbnMudGVtcGxhdGUudHlwZSB8fCBIVE1MVHlwZS5DT05URU5ULCBvcHRpb25zLnRlbXBsYXRlLmNvbnRlbnQpO1xuICAgIGlmIChvcHRpb25zLmRhdGEpIHtcbiAgICAgICAgaWYgKG9wdGlvbnMudHJhbnNsYXRpb25zKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5zbGF0aW9ucyA9IGF3YWl0IGdldFBhZ2VUcmFuc2xhdGlvbnMob3B0aW9ucy50cmFuc2xhdGlvbnMucmVzb3VyY2VUeXBlLCBvcHRpb25zLnRyYW5zbGF0aW9ucy50cmFuc2xhdGlvbnMpO1xuICAgICAgICAgICAgICAgIG9wdGlvbnMuZGF0YSA9IE9iamVjdC5hc3NpZ24ob3B0aW9ucy5kYXRhLCB0cmFuc2xhdGlvbnMpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZm9ybWF0IGZvciB0cmFuc2xhdGlvbnMuIE11c3QgYmUgSlNPTicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBNdXN0YWNoZS5yZW5kZXIoaHRtbCwgb3B0aW9ucy5kYXRhKTtcbiAgICB9XG4gICAgcmV0dXJuIGh0bWw7XG59O1xuXG5leHBvcnQgY29uc3QgaHRtbFRvUGRmID0gYXN5bmMgKG9wdGlvbnM6IFBERkZyb21IVE1MT3B0aW9ucykgPT4ge1xuICAgIGlmICghb3B0aW9ucy5wZGYpIHtcbiAgICAgICAgb3B0aW9ucy5wZGYgPSB7fTtcbiAgICB9XG4gICAgaWYgKCFvcHRpb25zLnRlbXBsYXRlICYmICFvcHRpb25zLnVybCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0IGxlYXN0IG9uZSBvZiB0ZW1wbGF0ZSBvciB1cmwgbXVzdCBiZSBzcGVjaWZpZWQnKTtcbiAgICB9XG4gICAgY29uc3QgYnJvd3NlciA9IGF3YWl0IHB1cHBldGVlci5sYXVuY2goeyBoZWFkbGVzczogdHJ1ZSB9KTtcbiAgICBjb25zdCBwYWdlID0gYXdhaXQgYnJvd3Nlci5uZXdQYWdlKCk7XG4gICAgaWYgKG9wdGlvbnMucGFnZT8uaGVpZ2h0KSB7XG4gICAgICAgIGF3YWl0IHBhZ2Uuc2V0Vmlld3BvcnQoe1xuICAgICAgICAgICAgd2lkdGg6IG9wdGlvbnMucGFnZS53aWR0aCB8fCAxNjAwLFxuICAgICAgICAgICAgaGVpZ2h0OiBvcHRpb25zLnBhZ2UuaGVpZ2h0IHx8IDc0NS42MCxcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLnRlbXBsYXRlKSB7XG4gICAgICAgIGNvbnN0IGh0bWwgPSBhd2FpdCBnZXRIVE1MKG9wdGlvbnMpO1xuICAgICAgICBhd2FpdCBwYWdlLnNldENvbnRlbnQoaHRtbCwgeyB3YWl0VW50aWw6ICduZXR3b3JraWRsZTAnIH0pO1xuICAgICAgICBpZiAob3B0aW9ucy50ZW1wbGF0ZS5jc3M/LmNvbnRlbnQpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhZ2VTdHlsZXMgPSBnZXRQYWdlU3R5bGVzQW5kU2NyaXB0KG9wdGlvbnMudGVtcGxhdGUuY3NzLnR5cGUsIG9wdGlvbnMudGVtcGxhdGUuY3NzLmNvbnRlbnQpO1xuICAgICAgICAgICAgYXdhaXQgcGFnZS5hZGRTdHlsZVRhZyhwYWdlU3R5bGVzKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAob3B0aW9ucy50ZW1wbGF0ZS5zY3JpcHQ/LmNvbnRlbnQpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhZ2VTY3JpcHQgPSBnZXRQYWdlU3R5bGVzQW5kU2NyaXB0KG9wdGlvbnMudGVtcGxhdGUuc2NyaXB0LnR5cGUsIG9wdGlvbnMudGVtcGxhdGUuc2NyaXB0LmNvbnRlbnQpO1xuICAgICAgICAgICAgYXdhaXQgcGFnZS5hZGRTY3JpcHRUYWcocGFnZVNjcmlwdCk7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBhd2FpdCBwYWdlLmdvdG8ob3B0aW9ucy51cmw/LmxpbmssIHsgd2FpdFVudGlsOiAnbmV0d29ya2lkbGUwJyB9KTtcbiAgICAgICAgaWYgKG9wdGlvbnMudXJsLmF1dGgpIHtcbiAgICAgICAgICAgIGF3YWl0IHBhZ2UuYXV0aGVudGljYXRlKHtcbiAgICAgICAgICAgICAgICB1c2VybmFtZTogb3B0aW9ucy51cmwuYXV0aC51c2VybmFtZSxcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogb3B0aW9ucy51cmwuYXV0aC5wYXNzd29yZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHBkZk9wdGlvbnMgPSB7XG4gICAgICAgIGZvcm1hdDogb3B0aW9ucy5wZGYuZm9ybWF0IHx8ICdBNCcsXG4gICAgICAgIHNjYWxlOiBvcHRpb25zLnBkZi5zY2FsZSB8fCAxLFxuICAgICAgICBsYW5kc2NhcGU6IG9wdGlvbnMucGRmLmxhbmRzY2FwZSB8fCBmYWxzZSxcbiAgICAgICAgbWFyZ2luOiBvcHRpb25zLnBkZi5tYXJnaW4gPyBvcHRpb25zLnBkZi5tYXJnaW4gOiB1bmRlZmluZWQsXG4gICAgICAgIGRpc3BsYXlIZWFkZXJGb290ZXI6ICEhb3B0aW9ucy50ZW1wbGF0ZS5oZWFkZXIgfHwgISFvcHRpb25zLnRlbXBsYXRlLmZvb3RlcixcbiAgICAgICAgaGVhZGVyVGVtcGxhdGU6IG9wdGlvbnMudGVtcGxhdGUuaGVhZGVyLFxuICAgICAgICBmb290ZXJUZW1wbGF0ZTogb3B0aW9ucy50ZW1wbGF0ZS5mb290ZXIsXG4gICAgfSBhcyBQREZPcHRpb25zO1xuXG4gICAgaWYgKG9wdGlvbnMucGRmLndyaXRlU3RyZWFtKSB7XG4gICAgICAgIGNvbnN0IHBkZlN0cmVhbSA9IGF3YWl0IHBhZ2UuY3JlYXRlUERGU3RyZWFtKHBkZk9wdGlvbnMpO1xuICAgICAgICBwZGZTdHJlYW0ucGlwZShvcHRpb25zLnBkZi53cml0ZVN0cmVhbSk7XG4gICAgICAgIHBkZlN0cmVhbS5vbignZW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgYXdhaXQgYnJvd3Nlci5jbG9zZSgpO1xuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBwZGYgPSBhd2FpdCBwYWdlLnBkZihwZGZPcHRpb25zKTtcbiAgICAgICAgYXdhaXQgYnJvd3Nlci5jbG9zZSgpO1xuICAgICAgICByZXR1cm4gcGRmO1xuICAgIH1cbn07XG4iXX0=